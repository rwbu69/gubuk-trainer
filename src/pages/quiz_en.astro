---
import QuizLayout from "../layouts/QuizLayout.astro";
import { readdir, readFile, writeFile, mkdir } from "fs/promises";
import path from "path";

const dataDir = path.join(
  process.cwd(),
  "data/extracted/with_release_en_without_version"
);

const files = await readdir(dataDir);
const jsonFiles = files.filter((file) => file.endsWith(".json"));

const characters = await Promise.all(
  jsonFiles.map(async (file) => {
    const filePath = path.join(dataDir, file);
    const content = await readFile(filePath, "utf-8");
    const data = JSON.parse(content);
    return {
      card_id: data.card_id,
      char_id: data.char_id,
      name_en: data.name_en,
      weight: data.profile?.weight || "N/A",
      ears: data.profile?.ears || "N/A",
      weak: data.profile?.weak || "N/A",
      tail: data.profile?.tail || "N/A",
      strong: data.profile?.strong || "N/A",
      three_sizes: data.charData?.three_sizes
        ? "B" +
          data.charData.three_sizes.b +
          " W" +
          data.charData.three_sizes.w +
          " H" +
          data.charData.three_sizes.h
        : "N/A",
      record: data.charData?.rl?.record || "N/A",
      active: data.charData?.rl?.active || "N/A",
      va_en: data.charData?.va_en || "N/A",
      title: data.title || "N/A",
      races: data.charData?.rl?.races || "N/A",
    };
  })
);

// Get unique characters (by char_id) for the dropdown
const uniqueCharacters = Array.from(
  new Map(characters.map((char) => [char.char_id, char])).values()
);

// Find matching images for each unique character
const imageDir = path.join(process.cwd(), "public/images/character_hd");
const imageFiles = await readdir(imageDir);

uniqueCharacters.forEach((char: any) => {
  const matchingImage = imageFiles.find((img) =>
    img.startsWith("hd_" + char.char_id + "_")
  );
  char.imageUrl = matchingImage
    ? import.meta.env.BASE_URL + "/images/character_hd/" + matchingImage
    : null;
});

// Write the data to a static JSON file for client-side fetching
const publicDataDir = path.join(process.cwd(), "public/data");
await mkdir(publicDataDir, { recursive: true });
await writeFile(
  path.join(publicDataDir, "characters-en.json"),
  JSON.stringify({ characters, uniqueCharacters })
);
---

<QuizLayout
  title="Kuis Karakter - Server EN"
  subtitle="Tebak karakter berdasarkan petunjuk yang diberikan (sori belom di translet le)"
  scriptSrc={`${import.meta.env.BASE_URL}/scripts/quiz.js`}
>
  <div slot="character-list">
    {
      uniqueCharacters.map((char) => (
        <button
          type="button"
          class="character-option w-full hover:bg-white/20 p-3 transition-colors duration-200 flex items-center gap-3 border-b border-white/10 last:border-b-0"
          data-char-id={char.char_id}
          data-card-id={char.card_id}
          data-name={char.name_en}
        >
          <img
            src={`${import.meta.env.BASE_URL}/images/character_hd/hd_${char.char_id}_${char.card_id}.png`}
            alt={char.name_en}
            class="w-12 h-12 object-cover rounded-lg flex-shrink-0"
          />
          <p class="text-white text-sm font-semibold text-left flex-1">
            {char.name_en}
          </p>
        </button>
      ))
    }
  </div>
</QuizLayout>
