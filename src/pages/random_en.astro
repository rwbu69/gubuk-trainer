---
import Layout from "../layouts/Layout.astro";
import { readdir, readFile } from "fs/promises";
import path from "path";

const dataDir = path.join(
  process.cwd(),
  "data/extracted/with_release_en_without_version"
);

const files = await readdir(dataDir);
const jsonFiles = files.filter((file) => file.endsWith(".json"));

const characters = await Promise.all(
  jsonFiles.map(async (file) => {
    const filePath = path.join(dataDir, file);
    const content = await readFile(filePath, "utf-8");
    const data = JSON.parse(content);
    return {
      card_id: data.card_id,
      char_id: data.char_id,
      name_en: data.name_en,
      title: data.title || "N/A",
      tagline: data.profile?.tagline || "N/A",
      weight: data.profile?.weight || "N/A",
      shoes: data.profile?.shoes || "N/A",
      dorm: data.profile?.dorm || "N/A",
      class: data.profile?.class || "N/A",
      ears: data.profile?.ears || "N/A",
      tail: data.profile?.tail || "N/A",
      strong: data.profile?.strong || "N/A",
      weak: data.profile?.weak || "N/A",
      family: data.profile?.family || "N/A",
      secrets: data.profile?.secrets || "N/A",
      va_en: data.charData?.va_en || "N/A",
      three_sizes: data.charData?.three_sizes
        ? `B${data.charData.three_sizes.b} W${data.charData.three_sizes.w} H${data.charData.three_sizes.h}`
        : "N/A",
      country: data.charData?.rl?.country || "N/A",
      death: data.charData?.rl?.death || "N/A",
      record: data.charData?.rl?.record || "N/A",
      earnings: data.charData?.rl?.earnings || "N/A",
      active: data.charData?.rl?.active || "N/A",
      release_en: data.release_en || "N/A",
    };
  })
);

// Get unique characters (by char_id) for the dropdown
const uniqueCharacters = Array.from(
  new Map(characters.map((char) => [char.char_id, char])).values()
);

// Find matching images for each unique character
const imageDir = path.join(process.cwd(), "public/images/character_hd");
const imageFiles = await readdir(imageDir);

uniqueCharacters.forEach((char: any) => {
  const matchingImage = imageFiles.find((img) =>
    img.startsWith(`hd_${char.char_id}_`)
  );
  char.imageUrl = matchingImage
    ? `/images/character_hd/${matchingImage}`
    : null;
});

// Write the data to a static JSON file for client-side fetching
import { writeFile, mkdir } from "fs/promises";
const publicDataDir = path.join(process.cwd(), "public/data");
await mkdir(publicDataDir, { recursive: true });
await writeFile(
  path.join(publicDataDir, "characters-random-en.json"),
  JSON.stringify({ characters, uniqueCharacters })
);
---

<Layout>
  <div
    class="min-h-screen bg-linear-to-br from-purple-900 via-blue-900 to-indigo-900"
  >
    <!-- Navigation -->
    <nav class="container mx-auto px-6 py-6">
      <div class="flex items-center justify-between">
        <a
          href="/gubuk-trainer/"
          class="text-white text-2xl font-bold tracking-wider hover:text-purple-300 transition-colors duration-300"
        >
          Gubuk Trainer
        </a>
      </div>
    </nav>

    <!-- Quiz Container -->
    <div class="container mx-auto px-6 py-8">
      <div class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-bold text-white text-center mb-8">
          Character Quiz - Random Mode ðŸŽ²
        </h1>

        <!-- Progress -->
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-4 mb-6">
          <div class="flex justify-between items-center mb-2">
            <span class="text-white font-semibold"
              >Petunjuk tersisa: <span id="clues-revealed">0</span>/10</span
            >
          </div>
          <div class="w-full bg-white/20 rounded-full h-3">
            <div
              id="progress-bar"
              class="bg-linear-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-500"
              style="width: 0%"
            >
            </div>
          </div>
        </div>

        <!-- Main Layout: Questions Left, Characters Right -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
          <!-- Right Side: Character Selector (shown first on mobile) -->
          <div class="lg:col-span-5 order-1 lg:order-2 relative z-40">
            <div
              class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 lg:sticky lg:top-6"
            >
              <label
                class="block text-2xl font-bold text-white mb-6 text-center"
                >Pilih Jawabanmu:</label
              >

              <!-- Custom Dropdown -->
              <div class="relative z-50">
                <button
                  id="dropdown-button"
                  type="button"
                  class="w-full bg-white/10 hover:bg-white/20 rounded-lg p-4 mt-9 border-2 border-white/20 transition-colors duration-200 flex items-center justify-between text-white"
                >
                  <span id="selected-text">Choose a character...</span>
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>

                <div
                  id="dropdown-menu"
                  class="hidden absolute z-60 w-full mt-2 bg-gray-900/95 backdrop-blur-lg rounded-lg border-2 border-white/20 max-h-96 overflow-hidden"
                >
                  <!-- Search Input -->
                  <div class="p-3 border-b border-white/20 sticky top-0 bg-gray-900">
                    <input
                      type="text"
                      id="character-search"
                      placeholder="Search character..."
                      class="w-full bg-white/10 text-white placeholder-gray-400 rounded-lg px-4 py-2 border border-white/20 focus:outline-none focus:border-purple-400 transition-colors"
                    />
                  </div>

                  <!-- Character List -->
                  <div id="character-list" class="overflow-y-auto max-h-80">
                    {
                      uniqueCharacters.map((char) => (
                        <button
                          type="button"
                          class="character-option w-full hover:bg-white/20 p-3 transition-colors duration-200 flex items-center gap-3 border-b border-white/10 last:border-b-0"
                          data-char-id={char.char_id}
                          data-card-id={char.card_id}
                          data-name={char.name_en}
                        >
                          <img
                            src={`${import.meta.env.BASE_URL}/images/character_hd/hd_${char.char_id}_${char.card_id}.png`}
                            alt={char.name_en}
                            class="w-12 h-12 object-cover rounded-lg shrink-0"
                          />
                          <p class="text-white text-sm font-semibold text-left flex-1">
                            {char.name_en}
                          </p>
                        </button>
                      ))
                    }
                  </div>
                </div>
              </div>

              <!-- Wrong Answers Display -->
              <div id="wrong-answers-container" class="mt-6 space-y-4 hidden">
              </div>
            </div>
          </div>

          <!-- Left Side: All Questions/Clues (shown second on mobile) -->
          <div class="lg:col-span-7 order-2 lg:order-1 relative z-0">
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8">
              <h3 class="text-2xl font-bold text-white mb-6 text-center">
                Petunjuk Karakter
              </h3>
              <div id="clues-container" class="space-y-4">
                <!-- Questions will be dynamically added here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Result Message -->
        <div
          id="result-message"
          class="hidden mt-6 p-4 rounded-xl text-center text-xl font-bold"
        >
        </div>

        <!-- Final Results -->
        <div id="final-results" class="hidden mt-12">
          <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-12 text-center">
            <div class="text-8xl mb-6" id="result-icon"></div>
            <h2 class="text-4xl font-bold text-white mb-4" id="result-title">
            </h2>
            <p class="text-2xl text-purple-200 mb-6">
              The answer was: <span
                id="correct-answer"
                class="text-white font-bold"></span>
            </p>
            <p class="text-xl text-purple-300 mb-8">
              You revealed <span
                id="final-clues"
                class="text-white font-bold"></span> clues
            </p>
            <button
              id="restart-btn"
              class="px-8 py-4 bg-linear-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-xl font-bold text-xl transition-all duration-300 transform hover:scale-105"
            >
              Play Again
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const scriptPath = window.location.pathname;
  const basePath = scriptPath.includes("/gubuk-trainer/")
    ? "/gubuk-trainer"
    : "";

  // Dynamically import the module
  import(`${basePath}/scripts/modules/CharacterRandomQuiz.js`).then((module) => {
    const { CharacterRandomQuiz } = module;
    
    fetch(`${basePath}/data/characters-random-en.json`)
      .then((response) => response.json())
      .then((data) => {
        const quiz = new CharacterRandomQuiz(
          data.characters,
          data.uniqueCharacters
        );
        quiz.init();
      });
  });
</script>
